<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>CATBot</title>
    <!-- Add this in the <head> section -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Favicon: Generated from CATBot_logo.png -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
    <!-- Apple Touch Icon for iOS devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <!-- Android Chrome icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <!-- Legacy shortcut icon for broader compatibility -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/catbot.css">
    <!-- Replace the script section in the head -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter3@4.0.7/umd/eventemitter3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>

    <!-- Three.js and VRM dependencies (VRM 1.0 and VRM 0.0 via modules) -->
    <script type="module">
        (async () => {
            try {
                // Import THREE.js and GLTFLoader
                const THREE_NS = await import('https://esm.sh/three@0.150.1');
                const { GLTFLoader } = await import('https://esm.sh/three@0.150.1/examples/jsm/loaders/GLTFLoader.js');
                
                // Load VRM library (version 3.x supports both VRM 0.0 and 1.0 models)
                const vrmModule = await import('https://esm.sh/@pixiv/three-vrm@3.4.3?deps=three@0.150.1');
                const { VRMAnimation, VRMAnimationLoaderPlugin } = await import('https://esm.sh/@pixiv/three-vrm-animation@3.4.3?deps=three@0.150.1');

                // Expose to global for non-module scripts below (do NOT mutate the module namespace)
                // THREE.js namespace import gives us the module object directly
                window.THREE = THREE_NS;
                window.GLTFLoader = GLTFLoader;
                // Store VRM loader and utils (same library works for both VRM 0.0 and 1.0)
                window.VRMLoaderPlugin = vrmModule.VRMLoaderPlugin;
                window.VRMUtils = vrmModule.VRMUtils;
                window.VRMAnimation = VRMAnimation;
                window.VRMAnimationLoaderPlugin = VRMAnimationLoaderPlugin;

                // Signal readiness
                window.__vrmModulesReady = true;
                console.log('VRM modules loaded successfully');
            } catch (error) {
                console.error('Failed to load VRM modules:', error);
                window.__vrmModulesReady = false;
                window.__vrmModulesError = error;
            }
        })();
    </script>
    <script src="ai-autogen-call.js"></script>
    <!-- Dependencies for PDF to PowerPoint conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
    <!-- Import Map to resolve bare module specifiers for OggOpusDecoder -->
    <script type="importmap">
    {
      "imports": {
        "@wasm-audio-decoders/common": "./node_modules/@wasm-audio-decoders/common/index.js",
        "@eshaz/web-worker": "./node_modules/@eshaz/web-worker/browser.js",
        "opus-decoder": "./node_modules/opus-decoder/index.js",
        "codec-parser": "./node_modules/codec-parser/index.js",
        "simple-yenc": "./node_modules/simple-yenc/dist/esm.js"
      }
    }
    </script>
    
    <!-- Opus decoder for client-side Opus audio decoding (worker-based, no WASM) -->
    <script type="module">
      // ---- Opus decoder bootstrap (JS-only + WebWorker, no WASM needed) ----
      async function initOpusDecoder() {
        // Import the small ESM wrapper
        const mod = await import('./libs/ogg-opus-decoder/OggOpusDecoder.js');

        // Normalize export shapes across versions
        const OggOpusDecoder = mod?.default || mod?.OggOpusDecoder;
        if (!OggOpusDecoder) throw new Error('OggOpusDecoder export not found');

        // Tell the wrapper where to find the decoder script and the worker script.
        // Most builds accept these two hints:
        const initOpts = {
          // The actual decoder bundle (no CORS because same-origin)
          decoderURL: './libs/ogg-opus-decoder/ogg-opus-decoder.min.js',
          // The worker wrapper that postMessages PCM back to us
          workerURL: './libs/ogg-opus-decoder/OggOpusDecoderWebWorker.js'
        };

        // Some builds don't need/accept init(); we try both paths safely.
        if (typeof OggOpusDecoder.init === 'function') {
          try { await OggOpusDecoder.init(initOpts); } catch { /* ok if not required */ }
        }

        // Audio scheduling helpers
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let playhead = 0;
        const schedule = (channelData, sampleRate) => {
          // Validate channelData structure
          if (!channelData || !Array.isArray(channelData) || channelData.length === 0) {
            console.warn('‚ö†Ô∏è Invalid channelData:', channelData);
                        return;
                    }
          // Handle both Float32Array[] and nested array structures
          const firstChannel = channelData[0];
          if (!firstChannel || firstChannel.length === 0) {
            console.warn('‚ö†Ô∏è Empty channel data');
            return;
          }
          
          const ch = channelData.length; // Number of channels
          const len = firstChannel.length; // Samples per channel
          const buf = audioCtx.createBuffer(ch, len, sampleRate); // Create audio buffer
          
          // Copy channel data into buffer
          for (let i = 0; i < ch; i++) {
            buf.getChannelData(i).set(channelData[i]); // Set channel data from decoded audio
          }
          
          // Create and schedule audio source
          const src = audioCtx.createBufferSource(); // Create buffer source node
          src.buffer = buf; // Set decoded buffer
          src.connect(audioCtx.destination); // Connect to audio output
          const t = Math.max(audioCtx.currentTime, playhead); // Calculate start time
          src.start(t); // Schedule playback
          playhead = t + buf.duration - 0.02; // Update playhead with 20ms overlap to hide seams
          
          console.log('üîä Scheduled audio chunk:', len, 'samples,', sampleRate, 'Hz,', ch, 'channels, duration:', buf.duration.toFixed(3), 's');
        };

        // Decoder instance - OggOpusDecoder with onDecode callback for streaming playback
        const decoder = new OggOpusDecoder({
          onDecode: ({ channelData, sampleRate }) => {
            // Call schedule function to play decoded audio
            schedule(channelData, sampleRate);
          },
          decoderURL: './libs/ogg-opus-decoder/ogg-opus-decoder.min.js',
          workerURL: './libs/ogg-opus-decoder/OggOpusDecoderWebWorker.js'
        });

        // Expose to your SSE pipeline
        window.__opus = {
          ready: true,
          decoder,
          audioCtx,
          schedule, // Expose schedule function for audio playback
          resume: () => audioCtx.resume(),
          playhead: 0 // Initialize playhead for PCM16 scheduling
        };
        console.log('‚úÖ Opus decoder ready (worker, JS-only)');
      }

      try { await initOpusDecoder(); }
      catch (e) {
        console.error('‚ùå Opus decoder init failed:', e);
        // Optional fallback to the big ML bundle:
        // 1) swap decoderURL to ./libs/ogg-opus-decoder/ogg-opus-decoder.opus-ml.min.js
        // 2) re-run initOpusDecoder()
        window.__opus = { ready: false };
      }
    </script>
</head>
<body>
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-card">
            <h2>Authentication Required</h2>
            <p class="auth-help">Log in or create an account to use CATBot.</p>
            <label for="auth-username">Username</label>
            <input type="text" id="auth-username" autocomplete="username" placeholder="Username">
            <label for="auth-password">Password</label>
            <input type="password" id="auth-password" autocomplete="current-password" placeholder="Password">
            <div class="auth-actions">
                <button id="auth-login-btn">Login</button>
                <button id="auth-signup-btn">Sign up</button>
                <button id="auth-logout-btn" type="button">Log out</button>
            </div>
            <div class="auth-status" id="auth-status"></div>
        </div>
    </div>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="header-left">
            <button class="hamburger-btn" id="hamburger-btn" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        <div class="header-center">
            <img src="/CATBot_logo.png" alt="CATBot Logo" class="header-logo">
            <h1>CATBot</h1>
            <span class="beta-badge">beta</span>
        </div>
        <div class="header-right">
            <button class="new-chat-btn" id="new-chat-btn-mobile" title="Conversation History">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- Settings Slide-out Menu -->
    <div class="settings-overlay" id="settings-overlay"></div>
    <div class="settings-menu" id="settings-menu">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-settings-btn" id="close-settings-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-content">
            <!-- Tool Settings in Settings Menu -->
            <div class="collapsible">
                <button type="button" class="collapsible-btn">Tool Settings</button>
                <div class="collapsible-content">
                    <label for="api-key">OpenAI API Key:</label>
                    <input type="password" id="api-key" value="X">
                    
                    <label for="endpoint-url">OpenAI API Endpoint:</label>
                    <input type="text" id="endpoint-url" value="http://localhost:1234/v1/chat/completions">
                    
                    <label for="news-api-key">News API Key:</label>
                    <input type="password" id="news-api-key" placeholder="Enter your News API key">
                    <span class="helper-text">Get your key from https://newsapi.org</span>
                    
                    <div class="toggle-container">
                        <label for="webcam-toggle">Webcam Mode:</label>
                        <label class="switch">
                            <input type="checkbox" id="webcam-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="toggle-container">
                        <label for="clipboard-toggle">Clipboard Vision Mode:</label>
                        <label class="switch">
                            <input type="checkbox" id="clipboard-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="toggle-container">
                        <label for="mute-toggle">Mute TTS:</label>
                        <label class="switch">
                            <input type="checkbox" id="mute-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <label for="system-prompt">System Prompt:</label>
                    <textarea id="system-prompt" placeholder="You are a friendly AI assistant called EVA."></textarea>
                    
                    <label for="user-name">User Name:</label>
                    <input type="text" id="user-name" value="User" placeholder="Your name">
                    <span class="helper-text">Your name shown in message history</span>
                    
                    <label for="assistant-name">Assistant Name:</label>
                    <input type="text" id="assistant-name" value="EVA" placeholder="Assistant name">
                    <span class="helper-text">Assistant name shown in message history</span>
                    
                    <label for="voice-dropdown">Select Voice:</label>
                    <select id="voice-dropdown">
                        <option value="">Loading voices...</option>
                    </select>

                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">

                    <label for="tts-service-toggle">TTS Service:</label>
                    <div class="toggle-container">
                        <input type="radio" id="tts-service-microsoft" name="tts-service" value="microsoft" checked>
                        <label for="tts-service-microsoft">Microsoft</label>
                        <input type="radio" id="tts-service-openai" name="tts-service" value="openai">
                        <label for="tts-service-openai">OpenAI-compatible (Chatterbox)</label>
                    </div>
                    <span class="helper-text">Choose between Microsoft browser TTS or local Chatterbox TTS API</span>

                    <label for="tts-endpoint-url">TTS API Endpoint:</label>
                    <input type="text" id="tts-endpoint-url" value="http://localhost:4123/v1" placeholder="http://localhost:4123/v1">
                    <span class="helper-text">Endpoint for OpenAI-compatible TTS service (Chatterbox default: http://localhost:4123/v1)</span>

                    <label for="tts-model-dropdown">TTS Model:</label>
                    <select id="tts-model-dropdown">
                        <option value="tts-1">tts-1</option>
                        <option value="tts-1-hd">tts-1-hd</option>
                    </select>
                    <span class="helper-text">Model for OpenAI-compatible TTS (tts-1 is faster, tts-1-hd is higher quality)</span>

                    <label for="tts-voice-dropdown">TTS Voice:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="tts-voice-dropdown" style="flex: 1;">
                            <option value="Empress">Empress</option>
                        </select>
                        <button type="button" id="refresh-tts-voices-btn" style="width: auto; margin: 0; padding: 8px 12px;" title="Refresh voices from TTS endpoint">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <span class="helper-text">Voice for OpenAI-compatible TTS (or your cloned voices from Chatterbox). Click refresh to load voices from the TTS endpoint.</span>

                    <div id="webcam-preview-container" style="display: none;">
                        <label>Webcam Preview:</label>
                        <video id="webcam-preview" style="width: 100%; border-radius: 10px;" autoplay playsinline></video>
                    </div>

                    <label for="base-model-dropdown">Base Chat Model:</label>
                    <select id="base-model-dropdown">
                        <option value="">Loading models...</option>
                    </select>
                    <span class="helper-text">Model used for regular chat (default model)</span>

                    <label for="tool-model-dropdown">Tool Processing Model:</label>
                    <select id="tool-model-dropdown">
                        <option value="">Loading models...</option>
                    </select>
                    <span class="helper-text">Model used for processing tool requests (e.g., website navigation)</span>

                    <label for="vision-model-dropdown">Vision Model (Clipboard/Webcam):</label>
                    <select id="vision-model-dropdown">
                        <option value="">Loading models...</option>
                    </select>
                    <span class="helper-text">Model used when webcam mode or clipboard image mode is enabled</span>

                    <label for="live2d-model-dropdown">Live2D Model:</label>
                    <select id="live2d-model-dropdown">
                        <option value="">Loading models...</option>
                    </select>
                    <span class="helper-text">Select which Live2D model to use (shows file name)</span>

                    <label for="live2d-model-list">Live2D Model Paths (one per line):</label>
                    <textarea id="live2d-model-list" rows="4" placeholder="./model_avatar/NAME/FILE.model3.json">./model_avatar/KITU17/KITU17.model3.json
./model_avatar/NVPU-demo/NVPU.model3.json
./model_avatar/RACOON01/RACOON01.model3.json</textarea>
                    <span class="helper-text">Add new model paths on new lines to make them available in the selector</span>

                    <label for="live2d-offset-range">Live2D Vertical Offset (px): <span id="live2d-offset-value">0</span></label>
                    <input type="range" id="live2d-offset-range" min="-400" max="400" step="5" value="0" />
                    <span class="helper-text">Fine-tune the model's vertical position in the view</span>

                    <label for="avatar-mode-toggle">Avatar Mode:</label>
                    <div class="toggle-container">
                        <input type="radio" id="live2d-mode" name="avatar-mode" value="live2d" checked>
                        <label for="live2d-mode">Live2D</label>
                        <input type="radio" id="vrm-mode" name="avatar-mode" value="vrm">
                        <label for="vrm-mode">VRM</label>
                    </div>
                    <span class="helper-text">Switch between 2D Live2D and 3D VRM avatar modes</span>

                    <label for="vrm-version-dropdown">VRM Version:</label>
                    <select id="vrm-version-dropdown">
                        <option value="1.0">VRM 1.0</option>
                        <option value="0.0">VRM 0.0</option>
                    </select>
                    <span class="helper-text">Select VRM format version (1.0 is newer, 0.0 is legacy)</span>

                    <label for="vrm-model-dropdown">VRM Model:</label>
                    <select id="vrm-model-dropdown">
                        <option value="">Loading models...</option>
                    </select>
                    <span class="helper-text">Select which VRM model to use (shows file name)</span>

                    <label for="vrm-model-list">VRM Model Paths (one per line):</label>
                    <textarea id="vrm-model-list" rows="4" placeholder="./model_avatar/NAME/FILE.vrm
Example: ./model_avatar/MyVRM/MyModel.vrm
Get VRM files from VRoid Studio or other 3D avatar creators">./model_avatar/Eva/Eva.vrm
./model_avatar/Greyson/Greyson.vrm
./model_avatar/Bianca/Bianca.vrm
./model_avatar/Esme/Esme.vrm</textarea>
                    <span class="helper-text">Add new VRM model paths on new lines to make them available in the selector</span>

                    <label for="vrm-scale-range">VRM Scale: <span id="vrm-scale-value">1.0</span></label>
                    <input type="range" id="vrm-scale-range" min="0.1" max="6.0" step="0.1" value="1.0" />
                    <span class="helper-text">Adjust the 3D model's scale in the view</span>

                    <label for="vrm-position-x-range">VRM Position X: <span id="vrm-position-x-value">0</span></label>
                    <input type="range" id="vrm-position-x-range" min="-10" max="10" step="0.1" value="0" />
                    <span class="helper-text">Adjust the 3D model's horizontal position</span>

                    <label for="vrm-position-y-range">VRM Position Y: <span id="vrm-position-y-value">0</span></label>
                    <input type="range" id="vrm-position-y-range" min="-10" max="10" step="0.1" value="0" />
                    <span class="helper-text">Adjust the 3D model's vertical position</span>

                    <label for="vrm-rotation-range">VRM Rotation: <span id="vrm-rotation-value">0</span></label>
                    <input type="range" id="vrm-rotation-range" min="-180" max="180" step="1" value="0" />
                    <span class="helper-text">Rotate the 3D model (degrees)</span>

                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="container chat-hidden">
        <div class="main-content">
            <!-- Avatar Display -->
            <div class="avatar-wrapper">
                <div id="live2d-container">
                    <canvas id="live2d-canvas"></canvas>
                </div>
                <div id="vrm-container" style="display: none;">
                    <canvas id="vrm-canvas"></canvas>
                </div>
                <!-- Message History - Overlay on top of avatar -->
                <div id="message-history"></div>
            </div>
            <textarea id="response-output" rows="30" readonly style="display: none;"></textarea>

            <div id="clipboard-preview" style="display: none; margin: 15px 0;">
                <div id="clipboard-status" style="font-size: 0.85em; color: #888; margin-bottom: 5px; font-style: italic;"></div>
                <img id="clipboard-image" style="max-width: 100%; display: none;">
                <p id="clipboard-text" style="display: none;"></p>
            </div>
        </div>
    </div>

    <!-- Conversation History Slide-out Panel -->
    <div class="conversation-overlay" id="conversation-overlay"></div>
    <div class="conversation-history-panel" id="conversation-history-panel">
        <div class="conversation-history-header">
            <h2>Conversations</h2>
            <button class="close-conversation-btn" id="close-conversation-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="conversation-history-content">
            <button class="new-conversation-btn-mobile" id="new-conversation-btn-mobile">
                <i class="fas fa-plus"></i> New Chat
            </button>
            <div class="conversation-list" id="conversation-list-mobile">
                <!-- Conversation items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Hide Chat Button - Above Input Area -->
    <div class="hide-chat-button-container">
        <button class="hide-chat-btn" id="hide-chat-btn" title="Show Chat">
            <i class="fas fa-chevron-up" id="hide-chat-icon"></i>
        </button>
    </div>

    <!-- Mobile Input Area - Fixed Bottom -->
    <div class="mobile-input-area">
        <div class="input-wrapper">
            <button class="input-action-btn" id="attach-btn" title="Attach">
                <i class="fas fa-plus"></i>
            </button>
            <textarea id="user-input" rows="1" placeholder="Ask Anything"></textarea>
            <div class="input-actions">
                <button class="input-action-btn" id="think-btn" title="Think">
                    <i class="fas fa-lightbulb"></i>
                    <span>Think</span>
                </button>
            </div>
            <button class="mic-btn" id="start-record-btn" title="Voice Input">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="send-btn-mobile" id="send-btn-mobile" title="Send" style="display: none;">
                <i class="fas fa-paper-plane"></i>
            </button>
            <!-- Hidden buttons for compatibility with existing code -->
            <button id="send-btn" style="display: none;"></button>
            <button id="philosopher-mode-btn" style="display: none;"></button>
            <button id="paste-btn" style="display: none;"></button>
        </div>
        <div id="status"></div>
    </div>

    <video id="webcam-video" style="position: absolute; left: -9999px;"></video>

    <script src="/js/app.js"></script>
</body>
</html>
